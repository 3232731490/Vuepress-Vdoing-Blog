---
title: HQL检索方式
date: 2021-10-01 17:35:42
permalink: /pages/0a5dd4/
categories:
  - 《Hibernate》学习笔记
  - 进阶
tags:
  - Hibernate
---

## HQL检索方式

### HQL检索方式包括步骤

1. 通过Session的createQuery()方法创建一个Query对象，包括一个HQL查询语句，HQL查询语句中可以包含命名参数

2. 动态绑定参数

   > 与`preparedStatement`类似
   >
   > > 绑定参数的两种形式：
   > >
   > > 1. 按参数名字绑定，在HQL查询语句中定义命名参数，命名参数以 “:” 开头
   > > 2. 按参数位置绑定： 在HQL查询语句中"?"来定义参数位置
   >
   > >相关方法：
   > >
   > >setEntity(): 把参数与一个持久化类绑定
   > >
   > >setParameter(): 绑定任意类型的参数，该方法的第三个参数显式指定Hibernate映射类型
   >
   > >HQL采用ORDERBY关键字对查询寻结果排序

3. 调用Query相关方法执行查询语句

   > Query接口支持方法链编程风格，它的setXxx()方法，返回自身实例，而不是void

   ```java
   // 一个例子
   //1. 创建Query对象
   // 占位符
   String hql1 = "From Employee e where e.salary > ? AND e.email like ? ORDER BY e.salary";
   Query query1 = session.createQuery(hql1);
   // 命名参数
   String hql1 = "From Employee e where e.salary > :Salary AND e.email like :Email AND e.dept=:Dept";
   Query query2 = session.createQuery(hql2);
   
   // 2. 动态绑定参数
   query1.setFloat(0,5000.0).setString(1,"%qq%");
   Department dept = new Department(1,"人事部")
   query2.setFloat("Salary",5000.0).setString("Email","%qq%").setEntity("Dept",dept);
   
   // 执行查询
   List<Employee> emps1 = query1.list();
   List<Employee> emps2 = query2.list();
   ```

   

### 几个细节

1. 分页查询

   ```java
   String hql = "From Employee";
   Query query = session.createQuery(hql);
   int pageNo = 3; // 指定查询第几页
   int pageSize = 5;	// 指定每页大小
   
   List<Employee> emps = query.setFirstResult((pageNo -1)*pageSize)	// 查询结果起始的编号
       					   .setMaxResults(pageSize)	// 每一页最大查询记录数
       					   .list()
   ```

2. 命名查询

   > 在映射配置文件中定义query并命名

   ```xml
   <query name="salaryEmps">
   	<![CDATA[FROM Employee e WHERE e.salary > :minSal AND e.salary < :maxSal]]>
   </query>
   ```

   > 由于查询语句中包含了">"和"<"，所以要用<![CDATA[]]> 包裹起来

   ```java
   Query query = session.getNamedQuery("salaryEmps");
   List<Employee> emps = query.setFloat("minSal",1000)
       					   .setFloat("maxSal",8000).list()
   ```

3. 投影查询

   ```java
   //1. 创建Query对象
   // 命名参数
   String hql1 = "select e.email,e.salary From Employee e where e.dept=:Dept";
   Query query2 = session.createQuery(hql2);
   
   // 2. 动态绑定参数
   Department dept = new Department(1,"人事部")
   query2.setEntity("Dept",dept);
   
   // 执行查询
   List<Object[]> emps1 = query2.list();
   ```

   ```java
   //1. 创建Query对象
   // 命名参数
   String hql1 = "select new Employee(e.email,e.salary) From Employee e where e.dept=:Dept";
   Query query2 = session.createQuery(hql2);
   
   // 2. 动态绑定参数
   Department dept = new Department(1,"人事部")
   query2.setEntity("Dept",dept);
   
   // 执行查询
   List<Employee> emps1 = query2.list();
   
   // 通过list中每一个Employee对象的get方法来得到投影的数据
   ```

4. 报表查询

   ```java
   String hql = "SELECT min(e.salary) , max(e.salary) FROM　Employee e GROUP BY e.dept HAVING min(salary) > :minSal";
   Query query2 = session.createQuery(hql2);
   
   // 2. 动态绑定参数
   query2.setFloat("minSal",1000);
   
   // 执行查询
   List<Object[]> emps1 = query2.list();
   ```



### 迫切左外链接

> 使用LEFT JOIN FETCH关键词标识迫切左外连接检索策略

1. list()方法返回的集合中存放着实体对象的引用，每个对象关联的其他对象集合都被初始化

2. 查询结果可能包含重复元素，可以通过一个HashSet来过滤重复元素

   ```java
   // 去重方式1
   // String hql = "Select DISTINCT d FROM Department d LEFT JOIN FETCH d.emps";
   String hql = "FROM Department d LEFT JOIN FETCH d.emps";
   Query query = session.createQuery(hql);
   List<Department> depts = query.list();
   // 去重方式2
   depts = new ArrayList<>(new LinkedHashSet(depts));
   ```

### 左外连接

> LEFT JOIN 关键字标识左外连接

1. list()方法返回的集合中存放的是对象数组类型

2. 根据配置文件可以决定对象关联的其他对象的集合的检索策略（立即检索或者延迟检索）

   ```java
   // 如果想让查询结果只包含department则设置select
   String hql1 = "Select DISTINCT d FROM Department d LEFT JOIN d.emps";
   String hql = "FROM Department d LEFT JOIN d.emps";
   Query query = session.createQuery(hql);
   Query query1 = session.createQuery(hql);
   // 查询结果为Department 
   List<Department> depts = query1.list();
   // 查询结果为一个对象数组
   List<Object[]> Objects = query.list();
   ```

   

