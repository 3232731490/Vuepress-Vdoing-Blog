---
title:  如何部署到个人服务器
date: 2021-09-29 17:52:18
permalink: /pages/0b6f0a/
categories:
  - 更多
  - 杂项
tags:
  - 杂谈
---

![画廊展示](https://tse1-mm.cn.bing.net/th/id/R-C.732225a2887ed09f6c37da51e0c9690f?rik=QhxiK7PhpzU1QQ&riu=http%3a%2f%2fwww.desktx.com%2fd%2ffile%2fwallpaper%2fscenery%2f20170217%2f9c2ea4858023fe79162a7941ce75b323.jpg&ehk=4W4dljnr3tMF9rLy4s%2b%2fv3Ve%2fx5WbfQckzcOfHeY1mc%3d&risl=&pid=ImgRaw&r=0)

# 将博客部署到自己的服务器上

> 部署到GitHub的访问速度太慢，甚至还频繁出现无法访问的情况，被逼无奈，只好麻烦一点将博客部署到自己的云服务器，方便访问
>
> > 在部署过程中又遇到了一系列问题，于是写下这篇博客记录一下


## 第一步：创建自己的git仓库

> 由于要部署到自己的服务器，所以在自己的服务器上创建一个Git仓库是很有必要的，本博客采用的是Gitea工具创建Git仓库

> 由于需要使用`gitea`，为了避免一系列繁琐的环境配置，此处使用`docker`以及`docke-compose`来构建`Gitea`的环境

1. 安装`docker`

   + 首先进入`docker`官方文档站(由于本博客所用服务器为`Centos`，所以选择`Centos`版本)，[docker]([Install Docker Engine on CentOS | Docker Documentation](https://docs.docker.com/engine/install/centos/))

   + 若是第一次安装则依次执行命令

     ```shell
     # 安装yum-utils包(它提供yum-config-manager实用程序)并设置稳定存储库。
     sudo yum install -y yum-utils
     sudo yum-config-manager \
         --add-repo \
         https://download.docker.com/linux/centos/docker-ce.repo
     # 安装Docker Engine和containerd的最新版本
     sudo yum install docker-ce docker-ce-cli containerd.io
     ```

   + 若之前安装有老版本的`docker`，则需要先执行下述命令

     ```shell
      sudo yum remove docker \
                       docker-client \
                       docker-client-latest \
                       docker-common \
                       docker-latest \
                       docker-latest-logrotate \
                       docker-logrotate \
                       docker-engine
     ```

   + 进行到此处就安装完成

   + 设置开机自启

     `systemctl enable docker.service`

   + 启动`docker`

     `systemctl start docker`

2. 安装`docker-compose`

   + 进入[安装页面]([Install Docker Compose | Docker Documentation](https://docs.docker.com/compose/install/)),选择你的操作系统版本，此处我选择`linux`

   + 依次执行下列命令

     ```shell
     # 下载最新版本的稳定版本docker-compose
     sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
     
     # 为docker-compose添加权限
      sudo chmod +x /usr/local/bin/docker-compose
      
      # 添加链接
      sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
      
      # 验证安装
      docker-compose --version
     ```

   + 至此`docker-compose`安装完成

   + 后台启动`docker-compose`

     `docker-compose up -d server`

     验证是否启动

     `docker-compose ps `

3. 安装`Gitea`

   + [官网]([Installation with Docker - Docs (gitea.io)](https://docs.gitea.io/en-us/install-with-docker/))

   + 在`/home`目录下创建目录`gitea`

   + 新建配置文件`docker-compose.yml`

     ```yaml
     version: "3"
     networks:
       gitea:
         external: false
     services:
       server:
         image: gitea/gitea:latest
         container_name: gitea
         environment:
           - USER_UID=1000
           - USER_GID=1000
           - DB_TYPE=mysql
           - DB_HOST=db:3306
           - DB_NAME=gitea
           - DB_USER=gitea
           - DB_PASSWD=gitea
         restart: always
         networks:
           - gitea
         volumes:
           - ./data:/data
           - /etc/timezone:/etc/timezone:ro
           - /etc/localtime:/etc/localtime:ro
         ports:
           - "3000:3000"
           - "222:222"
         depends_on:
           - db
       db:
         image: mysql:5.7
         restart: always
         environment:
           - MYSQL_ROOT_PASSWORD=gitea
           - MYSQL_USER=gitea
           - MYSQL_PASSWORD=gitea
           - MYSQL_DATABASE=gitea
         networks:
           - gitea
         volumes:
           - ./mysql:/var/lib/mysql
     ```

     

   + 在当前目录下启动`docker-compose`

     `docker-compose up server`

     会按照你的配置文件下载环境依赖

   + 开启防火墙端口3000，由于外网访问Gitea需要通过3000端口，所以开启此处防火墙端口3000需要打开，并且服务器中也要添加对应规则

     `firewall-cmd --permanent --zone=public --add-port=3000/tcp`

   + 外网访问`http://{主机ip}:3000`

     网站会要求你配置一些信息，配置SSH服务域名为你的主机`ip`，`Gitea`基本`URL`为`http://{主机ip}:3000`

   + 至此就完成安装，之后可以注册账号，登录就可以开始建立仓库正常使用了



> 若使用http传输每次提交都需要输入账号密码，所以接下来配置使用SSH传输

## 第二步： 配置SSH密钥

 1. 查看自己电脑的SSH密钥，路径一般为`‪C:\Users\用户\.ssh\id_rsa.pub`

 2. 复制密钥到 `Gitea`中

    `点击头像=>设置=>SSH/GPG密钥=>增加密钥`

	3.  配置成功后即可使用SSH进行仓库的一系列操作了

## 第三步： 将博客代码发布到个人仓库

1.  首先创建一个仓库用于存储博客的相关代码

   + 点击创建新仓库
   + 起名
   + 创建完毕，很简单吧

2.  配置博客部署脚本文件

   ```sh
   #!/usr/bin/env sh
   
   # 确保脚本抛出遇到的错误
   set -e
   
   # 生成静态文件
   npm run docs:build
   
   # 进入生成的文件夹
   cd docs/.vuepress/dist
   
   git init
   git add -A
   git commit -m 'deploy'
   
   # 格式为 git push -f ssh://git@{主机ip}:端口/{仓库地址} 分支名
   # ssh后面的部分可以建立好仓库后直接复制过来即可
   git push -f ssh://git@{ip}:222/root/Vuepress-Vdoing-Blog.git master
    
   cd -
   ```

3.  部署

   `yarn run deploy	或者	 npm run deploy`

4.  登录`Gitea`查看是否代码上传成功

5.  进入服务器进行，此处使用`Xshell`

## 第四步： 配置`nginx`以及同步博客

> 终于到了最关键的一步了，这也是最繁琐的一步，让我碰了不少璧，以下是配置过程

1. 下载安装`nginx`

   这个直接百度即可，没有什么特别需要注意的地方，此处放上一个个人感觉比较详细的教程以供参考[教程]([Linux下安装Nginx - 简书 (jianshu.com)](https://www.jianshu.com/p/9f2c162ac77c))

2. 配置`nginx.conf`

   ```shell
   server {
           listen       80;	# 监听端口
           server_name  106.14.196.77;	# 如果有域名此处可填域名，没有直接填主机ip即可，有域名之后让域名解析到此ip也可以
   
           charset utf-8;
   
           location / {	# 路由路径为 / 
               root   /home/project/blog;	# 网站目录
               index  index.html index.htm;
               try_files $uri $uri/ /index.html;
           }
   
           error_page   500 502 503 504  /50x.html;
           location = /50x.html {
               root   html;
           }
   }
   ```

3.  将仓库内的文件同步到`nignx`配置文件中的root目录

   > 此处有点小坑，不知道怎么了，此处配置了git的hook也无法自动帮我同步，于是我直接配置了两个定时任务，会在每天0点和12点帮我同步，一天更新两次应该够了吧🚓

   + 进入你所安装`Gitea`的目录，进入`data/git/repositories`目录，然后进入到你所创建的存储代码仓库的目录中，再进入`hooks`,执行以下命令

     ```shell
     mv post-update.sample post-update
     chmod 777 post-update
     vim post-update
     ```

     然后将`post-update`文件中的代码替换为以下代码

     ```shell
     #!/bin/sh
     #
     # An example hook script to prepare a packed repository for use over
     # dumb transports.
     #
     # To enable this hook, rename this file to "post-update".
     
     # exec git update-server-info
     
     GIT_REPO=/home/gitea/data/git/repositories/root/vuepress-vdoing-blog.git
     PUBLIC_WWW=/home/project/blog
     TMP_GIT_CLONE=/home/tmp/blog
     rm -rf ${TMP_GIT_CLONE}
     git clone $GIT_REPO $TMP_GIT_CLONE
     rm -rf ${PUBLIC_WWW}
     cp -rf ${TMP_GIT_CLONE} ${PUBLIC_WWW}
     ```

     > 上述代码的意思就是，先将仓库中的代码保存到一个临时存储区`TMP_GIT_CLONE`,再将这个临时存储区中的代码复制进网站仓库`PUBLIC_WWW`（即`nginx.conf`文件中配置的root属性）,此处修改的是post-update，按理来说当我提交了push操作后会执行这个脚本，但是并没有，所以我设置了两个定时任务，如果你部署时也遇到这个情况可以考虑我这个定时任务

     > 输入crontab -e后，黏贴以下代码

     `0 12 * * * sh /home/gitea/data/git/repositories/root/vuepress-vdoing-blog.git/hooks/post-update`
     `0 0 * * * sh /home/gitea/data/git/repositories/root/vuepress-vdoing-blog.git/hooks/post-update`

     > Tip: 注意： 你的文件目录可能跟我的不一样

4.  执行完这个操作后，你的网站目录下就会出现你的博客目录，在外网中访问你的网站即可



## 第五步： 完结撒花，总结

> 由于种种原因，本次博客的部署可谓是十分艰难，但好在最终还是成功的部署到了自己的服务器上，也学习到了很多东西，比如第一次使用`docker`等

[^💖]: 最后，也希望本篇博客能够帮助到你，共勉

::: tip 鸡汤
​	“没有激流就称不上勇进，没有山峰则谈不上攀登”
:::

